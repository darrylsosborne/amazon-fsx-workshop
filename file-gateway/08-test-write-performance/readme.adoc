= Test Write Performance
:toc:
:icons:
:linkattrs:
:imagesdir: ../resources/images


== Summary

This section will test the write performance of the local FSx File Gateway in Region 2, the same region as this Windows instance, and compare it to the write performance of the remote FSx for Windows File Server in Region 1.

There are many disk performance tools out there. link:https://aka.ms/diskspd[DiskSpd] have been pre-installed on the *WindowsInstance*.

== Duration

NOTE: It will take approximately 15 minutes to complete this section.


== Step-by-step Guide

IMPORTANT: Read through all steps below before continuing.

=== Compare file creations between the local FSx File Gateway and the remote FSx for Windows File Server

. Arrange the two *File Explorer* windows so you can see both contents at the same time.

. From the *File Explorer* window mapped to the *Z:* drive pointing to the remote FSx for Windows File Server, *_context-click_* (*_right-click_*) and select *New >> TextDocument* and give it a new name (e.g. Test1).
. Refresh the *File Explorer* window mapped to the *Y:* drive pointing to the local FSx File Gateway.
. Do you see the file in both *File Explorer* windows?
. From the *File Explorer* window mapped to the *Y:* drive pointing to the local FSx File Gateway, *_context-click_* (*_right-click_*) and select *New >> TextDocument* and give it a new name (e.g. Test2).
. Do you see the file in both *File Explorer* windows?

=== Compare file updates between the local FSx File Gateway and the remote FSx for Windows File Server

. Arrange the two *File Explorer* windows so you can see both contents at the same time.

. From the *File Explorer* window mapped to the *Z:* drive pointing to the remote FSx for Windows File Server, *_open_* the *Test1* file you created earlier and update its content (e.g. add your first name to the file).
. *_Save_* and *_close_* the file.
. From the *File Explorer* window mapped to the *Y:* drive pointing to the local FSx File Gateway, *_open_* the *Test1* file you updated earlier.
. Do you see the changes you made in the version of the file from the *File Explorer* window mapped to the *Y:* drive pointing to the local FSx File Gateway?
. Wait a minute and try again? Continue opening the *test1* file until you see the changes you made to the file from the *File Explorer* window mapped to the *Z:* drive pointing to the remote FSx for Windows File Server reflected in the the *File Explorer* window mapped to the *Y:* drive pointing to the local FSx File Gateway.
+
NOTE: Changes made to files in the underlying FSx for Windows File Server are periodically pushed to the attached FSx File Gateways.
+
. From the *File Explorer* window mapped to the *Y:* drive pointing to the local FSx File Gateway, *_open_* the *Test2* file you created earlier and update its content (e.g. add your last name to the file).
. *_Save_* and *_close_* the file.
. From the *File Explorer* window mapped to the *Z:* drive pointing to the remote FSx for Windows File Server, *_open_* the *Test2* file you updated earlier.
. Do you see the changes you made to the file when accessed from the *File Explorer* window mapped to the *Z:* drive pointing to the remote FSx for Windows File Server?
+
NOTE: Changes made to files in the FSx File Gateway are immediately pushed to the attached FSx for Windows File Server.


=== Compare file deletes between the local FSx File Gateway and the remote FSx for Windows File Server

. Arrange the two *File Explorer* windows so you can see both contents at the same time.

. From the *File Explorer* window mapped to the *Z:* drive pointing to the remote FSx for Windows File Server, *_delete_* the *test1* file you created earlier.
. Do you see *test1* in the *File Explorer* window mapped to the *Y:* drive pointing to the local FSx File Gateway?
. Wait a minute and try again? Continue *_refreshing_* the *File Explorer* window mapped to the *Y:* drive pointing to the local FSx File Gateway.
+
NOTE: Changes made to files in the underlying FSx for Windows File Server are periodically pushed to the attached FSx File Gateways.
+
. From the *File Explorer* window mapped to the *Y:* drive pointing to the local FSx File Gateway, *_delete_* the *test2* file you created earlier.
. Do you see *test2* from the *File Explorer* window mapped to the *Z:* drive pointing to the remote FSx for Windows File Server?
. Refresh the *File Explorer* window mapped to the *Z:* drive pointing to the remote FSx for Windows File Server.
. Do you see *test2* from the *File Explorer* window mapped to the *Z:* drive pointing to the remote FSx for Windows File Server?
+
NOTE: Changes made to files in the FSx File Gateway are immediately pushed to the attached FSx for Windows File Server.

=== DiskSpd Write tests

==== Test write performance accessing the remote FSx for Windows File Server.

. From the remote desktop session to the *Windows Instance*, *_click_* *Start* >> *Windows PowerShell*.

+
IMPORTANT: This section assumes the remote FSx for Windows File Server is mapped as the *Z:/* drive.
+
. *_Run_* the script below in the PowerShell session to create a 1 GB sparse file.
+
```sh
$random = $(Get-Random)
fsutil file createnew Z:\${env:computername}-$random.dat 1000000000
```
+
. Run the DiskSpeed script below in the PowerShell session to test write performance of the remote FSx for Windows File Server mapped as the **Z:** drive.
+
```sh
C:\Tools\DiskSpd-2.0.21a\amd64\DiskSpd.exe -d120 -w100 -r -t1 -o32 -b64K -Sr -L Z:\${env:computername}-$random.dat
```
+
* What was the P99 (99th %-tile) latency in ms of your test? - This is found in the DiskSpd output. It is in the *total* table at the bottom.
* * What was the P99.99 (99.99th %-tile) latency in ms of your test? - This is found in the DiskSpd output. It is in the *total* table at the bottom.
* What was the Total Write IO MiB/s? - This is found in the DiskSpd output. It is under *Write IO* under the *MiB/s* column.
* What was the I/O per second? - This is found in the DiskSpd output. It is under *Write IO* under the *I/O per s* column.
* What was the AvgLat? - This is found in the DiskSpd output. It is under *Write IO* under the *AvgLat* column.
+
. Copy the following table to your local computer and records the results
+
[cols="3,10"]
|===
| DiskSpd Metric | FSx for Windows File Server

| Write IO throughput (MiB/s)
a|

| Write IO I/O per s
a|

| Write IO AvgLat (ms)
a|

| Min %-tile
a|

| 50th %-tile
a|

| 90th %-tile
a|

| 99th %-tile
a|

| 99.99th %-tile
a|
|===
+
. Experiment with different DiskSpd parameter settings. Use the table below as a guide. Test with different block sizes (-b), number of outstanding I/O requests (-o), number of threads per file (-t), and disable local caching (-Sr).
+
[cols="3,10"]
|===
| Parameter | Description

| `-b<size>[K\|M\|G]`
a| Block size in bytes or KiB, MiB, or GiB (default = 64K).

| `-o<count>`
a| Number of outstanding I/O requests per-target per-thread. (1 = synchronous I/O, unless more than one thread is specified with by using `-F`.) (default = 2)

| `-r<size>[K\|M\|G]`
a| Random I/O aligned to the specified number of <alignment> bytes or KiB, MiB, GiB, or blocks. Overrides -s (default stride = block size).

| `-s<size>[K\|M\|G]`
a| Sequential stride size, offset between subsequent I/O operations in bytes or KiB, MiB, GiB, or blocks. Ignored if -r is specified (default access = sequential, default stride = block size).

| `-t<count>`
a| Number of threads per target. Conflicts with `-F`, which specifies the total number of threads.

| `-Sr`
a| Disable local caching.

|===

* What different parameters did you test?
* How did the different parameter options alter the results?


==== Test write performance accessing the local FSx File Gateway.

. From the remote desktop session to the *Windows Instance*, open another *Windows PowerShell* window by *_clicking_* *Start* >> *Windows PowerShell*.

+
IMPORTANT: This section assumes the remote FSx File Gateway is mapped as the *Y:/* drive.
+
. *_Run_* the script below in the PowerShell session to create a 1 GB sparse file.
+
```sh
$random = $(Get-Random)
fsutil file createnew Y:\${env:computername}-$random.dat 1000000000
```
+
. Run the DiskSpeed script below in the PowerShell session to test write performance of the remote FSx File Gateway mapped as the *Y:* drive.
+
```sh
C:\Tools\DiskSpd-2.0.21a\amd64\DiskSpd.exe -d120 -w100 -r -t1 -o32 -b64K -Sr -L Y:\${env:computername}-$random.dat
```
+
* What was the P99 (99th %-tile) latency in ms of your test? - This is found in the DiskSpd output. It is in the *total* table at the bottom.
* * What was the P99.99 (99.99th %-tile) latency in ms of your test? - This is found in the DiskSpd output. It is in the *total* table at the bottom.
* What was the Total Write IO MiB/s? - This is found in the DiskSpd output. It is under *Write IO* under the *MiB/s* column.
* What was the I/O per second? - This is found in the DiskSpd output. It is under *Write IO* under the *I/O per s* column.
* What was the AvgLat? - This is found in the DiskSpd output. It is under *Write IO* under the *AvgLat* column.
+
. Copy the following table to your local computer and records the results
+
[cols="3,10"]
|===
| DiskSpd Metric | FSx File Gateway

| Write IO throughput (MiB/s)
a|

| Write IO I/O per s
a|

| Write IO AvgLat (ms)
a|

| Min %-tile
a|

| 50th %-tile
a|

| 90th %-tile
a|

| 99th %-tile
a|

| 99.99th %-tile
a|
|===
+
. Experiment with different DiskSpd parameter settings. Use the table below as a guide. Test with different block sizes (-b), number of outstanding I/O requests (-o), number of threads per file (-t), and disable local caching (-Sr).
+
[cols="3,10"]
|===
| Parameter | Description

| `-b<size>[K\|M\|G]`
a| Block size in bytes or KiB, MiB, or GiB (default = 64K).

| `-o<count>`
a| Number of outstanding I/O requests per-target per-thread. (1 = synchronous I/O, unless more than one thread is specified with by using `-F`.) (default = 2)

| `-r<size>[K\|M\|G]`
a| Random I/O aligned to the specified number of <alignment> bytes or KiB, MiB, GiB, or blocks. Overrides -s (default stride = block size).

| `-s<size>[K\|M\|G]`
a| Sequential stride size, offset between subsequent I/O operations in bytes or KiB, MiB, GiB, or blocks. Ignored if -r is specified (default access = sequential, default stride = block size).

| `-t<count>`
a| Number of threads per target. Conflicts with `-F`, which specifies the total number of threads.

| `-Sr`
a| Disable local caching.

|===

* What different parameters did you test?
* How did the different parameter options alter the results?


=== DiskSpd Write Results

Below is a table with the results from a previous test. These results show a significant improvement when an Amazon EC2 Windows instance (us-west-2) writes to the local FSx File Gateway (us-west-2) compared to a remote FSx for Windows File Server (us-east-1).

+
[cols="3,10,10"]
|===
| DiskSpd Metric (us-west-2) | FSx for Windows File Server (us-east-1) | FSx File Gateway (us-west-2)

| Write IO throughput (MiB/s)
a| 27.65
a| 60.45

| Write IO I/O per s
a| 442.45
a| 967.18

| Write IO AvgLat (ms)
a| 72.322
a| 33.082

| Min %-tile
a| 71.617
a| 1.398

| 50th %-tile
a| 72.328
a| 32.890

| 90th %-tile
a| 72.928
a| 57.970

| 99th %-tile
a| 74.606
a| 68.359

| 99.99th %-tile
a| 108.662
a| 125.269
|===
+

* Compare your test results with those in the previous table. Do they differ substantially? Why?
* Using a hardware resources to host the FSx File Gateway will impact performance (e.g. allocating more CPUs, network bandwidth, larger/faster disks, more memory, etc.).

== Next section

Click the button below to go to the next section.

image::tear-down-workshop.png[link=../09-tear-down-workshop/, align="left",width=420]




